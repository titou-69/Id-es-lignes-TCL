<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Cartographie | Projets lign TCL</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

<style>
html, body { margin:0; padding:0; height:100%; width:100%; font-family: Arial, sans-serif; }
#map { height:100vh; width:100%; }

.modal {
  position: fixed;
  inset: 0;
  display: none;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 380px;
}
label { display:block; margin-top:10px; }
input, select { width:100%; padding:5px; margin-top:5px; }
button { margin-top:15px; padding:5px 10px; cursor:pointer; }

#btn-container {
  position:absolute; top:10px; right:10px; z-index:1100; display:flex; gap:5px;
}
#legend {
  position:absolute; bottom:10px; right:10px; z-index:1100;
  background:white; padding:10px; border-radius:6px;
  max-height:300px; overflow-y:auto; box-shadow:0 0 5px rgba(0,0,0,0.3);
}
.legend-item { margin-bottom:5px; display:flex; align-items:center; cursor:pointer; }
.legend-color { width:20px; height:10px; margin-right:5px; display:inline-block; }

#export-btn, #save-btn { position:absolute; bottom:10px; left:10px; z-index:1100; margin-top:5px; }
</style>
</head>

<body>
<div id="map"></div>

<div id="btn-container">
  <button id="newline-btn">Créer une nouvelle ligne</button>
</div>

<button id="export-btn">Exporter GeoJSON</button>
<button id="save-btn">Sauvegarder les modifications</button>

<div id="legend"><b>Lignes existantes :</b><div id="legend-items"></div></div>

<div id="modal" class="modal">
  <div class="modal-content" id="modal-content"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
// ===== INITIALISATION CARTE =====
const map = L.map('map').setView([45.75,4.85],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap'}).addTo(map);

// ===== CALQUES =====
const arrets = new L.FeatureGroup().addTo(map); // toujours au-dessus
const depots = new L.FeatureGroup().addTo(map);
const lignes = {}; // {nom: {layerGroup, color, weight, opacity, depart, arrivee}}

const iconeDepot = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[30,30], iconAnchor:[15,30]});

// ===== DRAW CONTROL =====
map.addControl(new L.Control.Draw({
  edit:{featureGroup:arrets},
  draw:{polygon:false, rectangle:false, circle:false, circlemarker:false}
}));

// ===== MODALE =====
function openModal(html, callback){
  const modal = document.getElementById("modal");
  const content = document.getElementById("modal-content");
  content.innerHTML = html;
  modal.style.display = "flex";

  // Slider live value
  content.querySelectorAll('input[type="range"]').forEach(slider=>{
    const display = document.createElement('span');
    display.style.float='right';
    display.innerText = slider.value;
    slider.parentNode.appendChild(display);
    slider.oninput = ()=>display.innerText = slider.value;
  });

  const form = content.querySelector("form");
  form.onsubmit = (e)=>{
    e.preventDefault();
    modal.style.display = "none";
    callback(new FormData(e.target));
  }

  // Bouton Annuler
  const cancelBtn = content.querySelector('button.cancel');
  if(cancelBtn){
    cancelBtn.onclick = ()=>{ modal.style.display="none"; };
  }
}

// ===== SELECTION PERSISTANTE =====
let selectedLayer = null;
function selectLayer(layer){
  // Désélection précédente
  if(selectedLayer){
    if(selectedLayer.originalStyle) selectedLayer.setStyle(selectedLayer.originalStyle);
    selectedLayer = null;
  }
  // Appliquer style sélection
  if(layer.setStyle){
    layer.originalStyle = {color: layer.options.color, weight: layer.options.weight, opacity: layer.options.opacity};
    layer.setStyle({color:'#ff0000', weight: layer.options.weight+2, opacity:1});
    selectedLayer = layer;
  } else {
    // Pour marker
    const origColor = layer.options.color;
    layer.setStyle({color:'#ff0000', weight:layer.options.weight+1});
    layer.originalStyle = {color:origColor};
    selectedLayer = layer;
  }
}

// ===== LEGEND DYNAMIQUE + interaction + zoom =====
function updateLegend(){
  const container = document.getElementById("legend-items");
  container.innerHTML = '';

  for(let l in lignes){
    const lineData = lignes[l];

    // Ligne principale
    const lineDiv = document.createElement('div');
    lineDiv.className = 'legend-item';
    const colorBox = document.createElement('span');
    colorBox.className='legend-color';
    colorBox.style.background = lineData.color;
    colorBox.style.opacity = lineData.opacity;
    lineDiv.appendChild(colorBox);
    const text = document.createElement('span');
    text.innerText = `${l} (${lineData.depart} → ${lineData.arrivee})`;
    lineDiv.appendChild(text);
    container.appendChild(lineDiv);

    // Sélection + zoom ligne
    lineDiv.onclick = ()=>{
      const bounds = lineData.layerGroup.getBounds();
      if(bounds.isValid()) map.fitBounds(bounds.pad(0.2));
      lineData.layerGroup.getLayers().forEach(seg=>selectLayer(seg));
      arrets.getLayers().forEach(ar=>{
        const popupContent = ar.getPopup().getContent();
        const arretLigne = popupContent.split('<br>')[1].replace('Ligne ','');
        if(arretLigne===l) selectLayer(ar);
      });
    };

    // Arrêts de cette ligne
    arrets.getLayers().forEach(arret=>{
      const popupContent = arret.getPopup().getContent();
      const arretNom = popupContent.split('<br>')[0].replace('<b>','').replace('</b>','');
      const arretLigne = popupContent.split('<br>')[1].replace('Ligne ','');
      if(arretLigne === l){
        const arretDiv = document.createElement('div');
        arretDiv.style.display='flex';
        arretDiv.style.alignItems='center';
        arretDiv.style.marginLeft='25px';
        const dot = document.createElement('span');
        dot.style.display='inline-block';
        dot.style.width='10px';
        dot.style.height='10px';
        dot.style.background=lineData.color;
        dot.style.borderRadius='50%';
        dot.style.marginRight='5px';
        arretDiv.appendChild(dot);
        const nameSpan = document.createElement('span');
        nameSpan.innerText = arretNom;
        arretDiv.appendChild(nameSpan);
        container.appendChild(arretDiv);

        // Sélection + zoom arrêt
        arretDiv.onclick = ()=>{
          map.setView(arret.getLatLng(),16);
          selectLayer(arret);
        };
      }
    });
  }
}

// ===== CREATION LIGNE =====
let ligneActive = null;
document.getElementById("newline-btn").onclick = ()=>{
  openModal(`
    <h3>Créer une nouvelle ligne</h3>
    <form>
      <label>Nom de la ligne</label><input name="ligne" required>
      <label>Couleur</label><input name="color" type="color" value="#3388ff">
      <label>Epaisseur <span>4</span></label><input name="weight" type="range" min="1" max="10" value="4" step="1">
      <label>Opacité <span>1</span></label><input name="opacity" type="range" min="0.1" max="1" value="1" step="0.1">
      <label>Terminus départ</label><input name="depart" required>
      <label>Terminus arrivée</label><input name="arrivee" required>
      <button>Créer</button>
      <button type="button" class="cancel">Annuler</button>
    </form>
  `, data=>{
    if(!data) return;
    const nom = data.get('ligne');
    const color = data.get('color');
    const weight = parseInt(data.get('weight'));
    const opacity = parseFloat(data.get('opacity'));
    const depart = data.get('depart');
    const arrivee = data.get('arrivee');
    if(!lignes[nom]){
      const layerGroup = new L.FeatureGroup().addTo(map);
      map.eachLayer(layer=>{
        if(layer===arrets) layer.bringToFront();
      });
      lignes[nom] = {layerGroup,color,weight,opacity,depart,arrivee};
      ligneActive = nom;
      updateLegend();
      alert(`Ligne "${nom}" créée. Les prochains segments tracés seront ajoutés à cette ligne.`);
    } else { alert('Cette ligne existe déjà!'); }
  });
}

// ===== CREATION OBJETS =====
map.on(L.Draw.Event.CREATED, e=>{
  const layer = e.layer;

  if(e.layerType==='marker'){
    let options='';
    for(let l in lignes) options += `<option value="${l}">${l}</option>`;
    openModal(`
      <h3>Nouvel arrêt</h3>
      <form>
        <label>Nom de l'arrêt</label><input name="nom" required>
        <label>Ligne</label>
        <select name="ligne" required>${options}</select>
        <button>Valider</button>
      </form>
    `, data=>{
      if(!data) return;
      const circle = L.circleMarker(layer.getLatLng(),{
        radius:6,
        color:'#000',
        fillColor:'#fff',
        fillOpacity:1,
        weight:1.5
      });
      circle.bindPopup(`<b>${data.get('nom')}</b><br>Ligne ${data.get('ligne')}`);
      circle.on('contextmenu', ()=>{ editArret(circle); });
      arrets.addLayer(circle);
      updateLegend();
    });
  }

  if(e.layerType==='polyline'){
    if(!ligneActive){
      let options='';
      for(let l in lignes) options += `<option value="${l}">${l}</option>`;
      openModal(`
        <h3>Attribuer le segment à une ligne</h3>
        <form>
          <label>Ligne</label>
          <select name="ligne" required>${options}</select>
          <button>Valider</button>
        </form>
      `, data=>{
        if(!data) return;
        addSegmentToLine(layer,data.get('ligne'));
      });
    } else {
      addSegmentToLine(layer,ligneActive);
    }
  }
});

function addSegmentToLine(layer,ligneName){
  const lData = lignes[ligneName];
  layer.setStyle({color:lData.color, weight:lData.weight, opacity:lData.opacity});
  layer.bindPopup(`<b>Ligne ${ligneName}</b>`);
  layer.on('contextmenu', ()=>{ editSegment(layer); });
  lData.layerGroup.addLayer(layer);
  updateLegend();
}

// ===== CREER DEPOT =====
function creerDepot(){
  let options='';
  for(let l in lignes) options += `<option value="${l}">${l}</option>`;
  openModal(`
    <h3>Nouveau dépôt</h3>
    <form>
      <label>Nom du dépôt</label><input name="depot" required>
      <label>Ligne associée</label>
      <select name="ligne">${options}</select>
      <button>Valider</button>
    </form>
  `, data=>{
    if(!data) return;
    const d = L.marker(map.getCenter(),{icon:iconeDepot});
    d.bindPopup(`<b>Dépôt ${data.get('depot')}</b><br>Ligne : ${data.get('ligne')}`);
    depots.addLayer(d);
  });
}
map.on('dblclick', e=>creerDepot());

// ===== EDIT FUNCTIONS =====
function editArret(circle){
  let options='';
  for(let l in lignes) options += `<option value="${l}">${l}</option>`;
  openModal(`
    <h3>Modifier arrêt</h3>
    <form>
      <label>Nom</label><input name="nom" value="${circle.getPopup().getContent().split('<br>')[0].replace('<b>','').replace('</b>','')}">
      <label>Ligne</label>
      <select name="ligne">${options}</select>
      <button>Valider</button>
    </form>
  `, data=>{
    if(!data) return;
    circle.bindPopup(`<b>${data.get('nom')}</b><br>Ligne ${data.get('ligne')}`);
    updateLegend();
  });
}

function editSegment(layer){
  let options='';
  for(let l in lignes) options += `<option value="${l}">${l}</option>`;
  openModal(`
    <h3>Modifier segment</h3>
    <form>
      <label>Ligne</label>
      <select name="ligne">${options}</select>
      <button>Valider</button>
      <button type="button" class="delete">Supprimer la ligne</button>
      <button type="button" class="cancel">Annuler</button>
    </form>
  `, data=>{
    if(!data) return;
    // Supprimer la ligne
    const deleteBtn = document.querySelector('.delete');
    if(deleteBtn){
      deleteBtn.onclick = ()=>{
        for(let l in lignes){
          if(lignes[l].layerGroup.hasLayer(layer)){
            map.removeLayer(lignes[l].layerGroup);
            delete lignes[l];
          }
        }
        updateLegend();
        document.getElementById("modal").style.display="none";
      };
    }
    // Modifier segment
    for(let l in lignes){
      if(lignes[l].layerGroup.hasLayer(layer)) lignes[l].layerGroup.removeLayer(layer);
    }
    addSegmentToLine(layer, data.get('ligne'));
  });
}

// ===== EXPORT & SAUVEGARDE =====
document.getElementById("export-btn").onclick = ()=>{ exportGeoJSON(); }
document.getElementById("save-btn").onclick = ()=>{
  const data = exportGeoJSON();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'reseau-bus-sauvegarde.geojson';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function exportGeoJSON(){
  const exportData = { arrets: arrets.toGeoJSON(), depots: depots.toGeoJSON(), lignes:{} };
  for(let l in lignes) exportData.lignes[l] = lignes[l].layerGroup.toGeoJSON();
  return exportData;
}
</script>
</body>
</html>
