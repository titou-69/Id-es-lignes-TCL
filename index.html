  <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>R√©seau de bus</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    #map {
      width: 100%;
      height: 100vh;
      background: #eee;
    }

    /* MODALE */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      width: 320px;
      border-radius: 8px;
    }

    label { display: block; margin-top: 10px; }
    input { width: 100%; padding: 5px; margin-top: 5px; }
    button { margin-top: 15px; padding: 5px 10px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- MODALE -->
  <div id="modal" class="modal">
    <div class="modal-content" id="modal-content"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
    // Initialisation carte
    const map = L.map('map').setView([45.75, 4.85], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Groupes de calques
    const arrets = new L.FeatureGroup().addTo(map);
    const lignes = {};

    // Leaflet Draw
    map.addControl(new L.Control.Draw({
      edit: { featureGroup: arrets },
      draw: {
        polygon: false,
        rectangle: false,
        circle: false,
        circlemarker: false
      }
    }));

    // Fonction modale
    function openModal(html, callback) {
      const modal = document.getElementById("modal");
      const content = document.getElementById("modal-content");
      content.innerHTML = html;
      modal.style.display = "flex";

      content.querySelector("form").onsubmit = (e) => {
        e.preventDefault();
        modal.style.display = "none";
        callback(new FormData(e.target));
      };
    }

    // Gestion cr√©ation objet
    map.on(L.Draw.Event.CREATED, function(e) {
      const layer = e.layer;

      // üìç ARR√äT
      if (e.layerType === 'marker') {
        openModal(`
          <h3>Nouvel arr√™t</h3>
          <form>
            <label>Nom de l'arr√™t</label>
            <input name="nom" required>

            <label>Ligne</label>
            <input name="ligne" required>

            <button>Valider</button>
          </form>
        `, data => {
          layer.bindPopup(`<b>${data.get('nom')}</b><br>Ligne ${data.get('ligne')}`);
          arrets.addLayer(layer);
        });
      }

      // üßµ LIGNE
      if (e.layerType === 'polyline') {
        openModal(`
          <h3>Nouvelle ligne</h3>
          <form>
            <label>Num√©ro de ligne</label>
            <input name="ligne" required>

            <label>D√©part</label>
            <input name="depart">

            <label>Arriv√©e</label>
            <input name="arrivee">

            <button>Valider</button>
          </form>
        `, data => {
          const numLigne = data.get('ligne');
          if (!lignes[numLigne]) {
            lignes[numLigne] = new L.FeatureGroup().addTo(map);
          }
          layer.bindPopup(`<b>Ligne ${numLigne}</b><br>${data.get('depart')} ‚Üí ${data.get('arrivee')}`);
          lignes[numLigne].addLayer(layer);
        });
      }
    });
  </script>
</body>
</html>
